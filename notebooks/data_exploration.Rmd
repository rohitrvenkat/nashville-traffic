---
title: "R Notebook"
output: html_notebook
---

```{r message=FALSE, warning=FALSE}
library(leaflet)
library(leafgl)
library(sf)
library(tidyverse)
library(lubridate)
library(htmltools)
```

```{r}
accidents_1 <- st_read("../data/traffic_accidents_2021_11_23/geo_export_843312ea-42b0-4c02-a5a6-277108a3e379.shp", as_tibble = T, quiet = T) %>%
  st_transform('+proj=longlat +datum=WGS84') %>%
  filter(!st_is_empty(.)) %>%
  filter(!geometry %in% st_sfc(st_point(c(0, 0))))

accidents_2 <- st_read("../data/traffic_accidents_2022_01_11/geo_export_80ccc574-077c-4ad8-b6d5-668c371ae1f9.shp", as_tibble = T, quiet = T) %>%
  st_transform('+proj=longlat +datum=WGS84') %>%
  filter(!st_is_empty(.)) %>%
  filter(!geometry %in% st_sfc(st_point(c(0, 0))))

accidents <- bind_rows(accidents_1, accidents_2) %>% 
  distinct(accident_n, .keep_all = T)

colnames(accidents) <-
  c("accident_n", "date", "time", "motor_vehicles_n", "injuries_n", "fatalities_n",
    "property_damage", "hit_and_run", "reporting_officer", "collision_type_code",
    "collision_type_desc", "weather_code", "weather_desc", "illumination_code",
    "illumination_desc", "harmful_code", "harmful_desc", "street_address", "city",
    "state", "zip", "rpa", "precinct", "lat", "long", "geometry")

accidents <- accidents %>%
  mutate(year = year(date), month = month(date), day = day(date), .after = date) %>%
  filter(year < 2022) %>%
  mutate(injury = injuries_n > 0, .after = injuries_n) %>%
  mutate(hit_and_run = as.logical(hit_and_run))
```

```{r}
roads <- st_read("../data/kx-nashville-tennessee-road-centerlines/nashville-tennessee-road-centerlines.shp", as_tibble = T, quiet = T) %>%
  st_transform('+proj=longlat +datum=WGS84')

colnames(roads) <- 
  c("transport_edge_id", "st_length", "suffix_dir", "legislation", "is_state_aid", 
    "min_width", "from_maint", "created_user", "last_paved", "is_state_route", 
    "to_maint", "last_edited_date", "condition_date", "pave_group", "verify", 
    "navigable", "max_weight", "abandonment", "row_width", "right_from", "location", 
    "one_way", "pave_length", "update_timestamp", "zip_right", "class", "condition", 
    "accepted_date", "left_from", "warranty_date", "min_height", "driving_time", 
    "suffix_type", "route_name", "former_name", "last_edited_user", "left_to", 
    "usd_gsd", "full_name", "official_status", "easement_ret", "name", "facility_id", 
    "zip_left", "description", "speed_limit", "legislation_2", "user_id", "install_date", 
    "legacy_id", "pm_oci", "prefix_dir", "state_route_no", "description_2", "alt_name", 
    "created_date", "seq_id", "us_route_no", "right_to", "geometry")

roads <- roads %>% 
  select(transport_edge_id, seq_id, full_name, prefix_dir, name, suffix_type, 
         suffix_dir, from_maint, to_maint, speed_limit, driving_time, class, 
         min_width, st_length)
```

```{r}
nearest <- st_nearest_feature(accidents, roads)
accidents_to_roads <- bind_cols(accidents %>% st_drop_geometry(), roads[nearest, ])
```

```{r}
saveRDS(accidents, "../shiny_app/data/accidents.rds")
saveRDS(roads, "../shiny_app/data/roads.rds")
saveRDS(accidents_to_roads, "../shiny_app/data/accidents_to_roads.rds")
```

```{r}
accidents_filtered <- accidents %>%
  sample_n(1000)

accidents_filtered$label <- 
  paste0("<b>Date:</b> ", accidents_filtered$date, "<br>",
         "<b>Time:</b> ", accidents_filtered$time, "<br>", 
         "<b>Street Address:</b> ", accidents_filtered$street_address, "<br>",
         "<b>Harmful Description:</b> ", accidents_filtered$harmful_desc, "<br>",
         "<b>Collision Type Description:</b> ", accidents_filtered$collision_type_desc, "<br>",
         "<b>Number of Vehicles:</b> ", accidents_filtered$motor_vehicles_n, "<br>",
         "<b>Number of Injuries:</b> ", accidents_filtered$injuries_n) %>%
  lapply(htmltools::HTML)

interstates <- roads %>% filter(class %in% c(1,2))
highways <- roads %>% filter(class %in% c(3,4))
main_roads <- roads %>% filter(class %in% c(5))
small_roads <- roads %>% filter(class %in% c(6,7))

map <- leaflet(options = leafletOptions(minZoom = 10, dragging = TRUE)) %>%
  addProviderTiles(provider = "CartoDB.PositronNoLabels") %>%
  setView(lng = -86.7816, lat = 36.1627, zoom = 11) %>%
  setMaxBounds(lng1 = -86.7816 + 1, 
               lat1 = 36.1627 + 1, 
               lng2 = -86.7816 - 1, 
               lat2 = 36.1627 - 1) %>%
  addPolylines(data = small_roads, color = "lightgrey", opacity = 0.75, weight = 0.5) %>%
  addPolylines(data = main_roads, color = "lightgrey", opacity = 1, weight = 0.5) %>%
  addPolylines(data = highways, color = "grey", opacity = 0.5, weight = 1) %>%
  addPolylines(data = interstates, color = "#F6CF65", opacity = 0.8, weight = 2) %>%
  addCircleMarkers(data = accidents_filtered,
                   weight = 0.5,
                   radius = 2,
                   fillColor = "red",
                   fillOpacity = 0.75,
                   color = "white",
                   label = ~label)

map
```

```{r}
accidents_to_roads %>%
  count(year) %>%
  mutate(year = as.factor(year)) %>%
  ggplot(aes(x = year, y = n)) + 
  geom_bar(stat = "identity")
```

```{r}
accidents_to_roads %>%
  drop_na(injury) %>%
  group_by(year) %>%
  count(injury) %>%
  mutate(year = as.factor(year)) %>%
  ggplot(aes(x = year, y = n, fill = injury)) +
  geom_bar(stat = "identity", position = "fill")
```

```{r}
accidents_to_roads %>%
  filter(hit_and_run != "?") %>%
  group_by(year) %>%
  count(hit_and_run) %>%
  mutate(year = as.factor(year)) %>%
  ggplot(aes(x = year, y = n, fill = hit_and_run)) +
  geom_bar(stat = "identity", position = "fill")
```

```{r}
accidents_to_roads %>% 
  group_by(year) %>% 
  count(month) %>% 
  group_by(month) %>%
  summarize_at(vars(n), list(mean = mean, sd = sd)) %>%
  mutate(month = as.factor(month)) %>%
  ggplot(aes(x = month, y = mean)) + 
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.2)
```

```{r}
accidents_to_roads %>%
  drop_na(injury) %>%
  group_by(month) %>%
  count(injury) %>%
  mutate(month = as.factor(month)) %>%
  ggplot(aes(x = month, y = n, fill = injury)) +
  geom_bar(stat = "identity", position = "fill")
```


```{r}
accidents_to_roads %>%
  drop_na(injury) %>%
  group_by(year, month) %>%
  count(injury) %>%
  group_by(month, injury) %>%
  summarize_at(vars(n), list(mean = mean, sd = sd)) %>%
  mutate(month = as.factor(month)) %>%
  ggplot(aes(x = month, y = mean, ymin = mean - sd, ymax = mean + sd, fill = injury)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(position = position_dodge(width = 0.9), width = 0.3)
```

```{r}
accidents_to_roads %>%
  filter(hit_and_run != "?") %>%
  group_by(month) %>%
  count(hit_and_run) %>%
  mutate(month = as.factor(month)) %>%
  ggplot(aes(x = month, y = n, fill = hit_and_run)) +
  geom_bar(stat = "identity", position = "fill")
```

```{r}
accidents_to_roads %>%
  filter(hit_and_run != "?") %>%
  group_by(year, month) %>%
  count(hit_and_run) %>%
  group_by(month, hit_and_run) %>%
  summarize_at(vars(n), list(mean = mean, sd = sd)) %>%
  mutate(month = as.factor(month)) %>%
  ggplot(aes(x = month, y = mean, ymin = mean - sd, ymax = mean + sd, fill = hit_and_run)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(position = position_dodge(width = 0.9), width = 0.3)
```

```{r message=FALSE, warning=FALSE}
accidents_to_roads %>%
  group_by(transport_edge_id, full_name, class) %>%
  summarize(accidents = n()) %>%
  arrange(desc(accidents))
```

```{r message=FALSE, warning=FALSE}
accidents_to_roads %>%
  group_by(full_name, class) %>%
  summarize(accidents = n()) %>%
  arrange(desc(accidents))
```

```{r}
accidents_to_roads %>% 
  group_by(full_name) %>%
  summarize(injury_accidents = sum(injury), non_injury_accidents = sum(!injury)) %>%
  mutate(total_accidents = injury_accidents + non_injury_accidents) %>%
  mutate(injury_accident_pct = injury_accidents / total_accidents) %>%
  filter(total_accidents >= 500) %>%
  arrange(desc(injury_accident_pct))
```

```{r}
accidents_to_roads %>% 
  group_by(transport_edge_id, full_name) %>%
  summarize(injury_accidents = sum(injury), non_injury_accidents = sum(!injury)) %>%
  mutate(total_accidents = injury_accidents + non_injury_accidents) %>%
  mutate(injury_accident_pct = injury_accidents / total_accidents) %>%
  filter(total_accidents >= 10) %>%
  arrange(desc(injury_accident_pct))
```

```{r message=FALSE, warning=FALSE}
accidents_by_road <- accidents_to_roads %>% 
  group_by(transport_edge_id) %>%
  summarize(accidents = n()) %>%
  right_join(roads, by = "transport_edge_id") %>%
  mutate(accidents = replace_na(accidents, 0)) %>%
  st_sf(sf_column_name = 'geometry')

roads_class_1 <- accidents_by_road %>% filter(class == 1)
roads_class_2 <- accidents_by_road %>% filter(class == 2)
roads_class_3 <- accidents_by_road %>% filter(class == 3)
roads_class_4 <- accidents_by_road %>% filter(class == 4)
roads_class_5 <- accidents_by_road %>% filter(class == 5)
roads_class_6 <- accidents_by_road %>% filter(class == 6)
roads_class_7 <- accidents_by_road %>% filter(class == 7)

pal <- colorNumeric(palette = "RdYlBu", domain = NULL, reverse = T)

map <- leaflet(options = leafletOptions(minZoom = 11, dragging = TRUE)) %>%
  addProviderTiles(provider = "CartoDB.Positron") %>%
  setView(lng = -86.7816, lat = 36.1627, zoom = 11) %>%
  setMaxBounds(lng1 = -86.7816 + 1, 
               lat1 = 36.1627 + 1, 
               lng2 = -86.7816 - 1, 
               lat2 = 36.1627 - 1) %>%
  addPolylines(data = roads_class_1, color = ~pal(accidents), opacity = 0.8, weight = 2) %>%
  addPolylines(data = roads_class_2, color = ~pal(accidents), opacity = 0.8, weight = 2) %>%
  addPolylines(data = roads_class_3, color = ~pal(accidents), opacity = 0.8, weight = 1) %>%
  addPolylines(data = roads_class_4, color = ~pal(accidents), opacity = 0.8, weight = 1) %>%
  addPolylines(data = roads_class_5, color = ~pal(accidents), opacity = 0.8, weight = 1) %>%
  addPolylines(data = roads_class_6, color = ~pal(accidents), opacity = 0.8, weight = 1) %>%
  addPolylines(data = roads_class_7, color = ~pal(accidents), opacity = 0.8, weight = 1)

map
```

```{r}
accidents_to_roads %>% 
  count(year, sort = F)

accidents_to_roads %>% 
  count(motor_vehicles_n, sort = T)

accidents_to_roads %>% 
  count(injuries_n, sort = T)

accidents_to_roads %>% 
  count(property_damage, sort = T)

accidents_to_roads %>% 
  count(hit_and_run, sort = T)

accidents_to_roads %>% 
  count(collision_type_desc, sort = T)

accidents_to_roads %>% 
  count(weather_desc, sort = T)

accidents_to_roads %>% 
  count(illumination_desc, sort = T)
```

```{r}
pedestrians <- accidents_to_roads[grepl("PEDESTRIAN", accidents_to_roads$harmful_desc), ]

pedestrians %>% 
  count(motor_vehicles_n, sort = T)

pedestrians %>% 
  count(injuries_n, sort = T)

pedestrians %>% 
  count(property_damage, sort = T)

pedestrians %>% 
  count(hit_and_run, sort = T)

pedestrians %>% 
  count(collision_type_desc, sort = T)

pedestrians %>% 
  count(weather_desc, sort = T)

pedestrians %>% 
  count(illumination_desc, sort = T)
```

```{r}
bicyclists <- accidents_to_roads[grepl("PEDALCYCLE", accidents_to_roads$harmful_desc), ]

bicyclists %>% 
  count(motor_vehicles_n, sort = T)

bicyclists %>% 
  count(injuries_n, sort = T)

bicyclists %>% 
  count(property_damage, sort = T)

bicyclists %>% 
  count(hit_and_run, sort = T)

bicyclists %>% 
  count(collision_type_desc, sort = T)

bicyclists %>% 
  count(weather_desc, sort = T)

bicyclists %>% 
  count(illumination_desc, sort = T)
```
