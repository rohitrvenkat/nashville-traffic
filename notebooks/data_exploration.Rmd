---
title: "R Notebook"
output: html_notebook
---

```{r message=FALSE, warning=FALSE}
library(leaflet)
library(leafgl)
library(sf)
library(tidyverse)
library(lubridate)
library(htmltools)
```

```{r}
roads <- st_read("../data/kx-nashville-tennessee-road-centerlines/nashville-tennessee-road-centerlines.shp", as_tibble = T, quiet = T) %>%
  st_transform('+proj=longlat +datum=WGS84')

colnames(roads) <- 
  c("transport_edge_id", "st_length", "suffix_dir", "legislation", "is_state_aid", 
    "min_width", "from_maint", "created_user", "last_paved", "is_state_route", 
    "to_maint", "last_edited_date", "condition_date", "pave_group", "verify", 
    "navigable", "max_weight", "abandonment", "row_width", "right_from", "location", 
    "one_way", "pave_length", "update_timestamp", "zip_right", "class", "condition", 
    "accepted_date", "left_from", "warranty_date", "min_height", "driving_time", 
    "suffix_type", "route_name", "former_name", "last_edited_user", "left_to", 
    "usd_gsd", "full_name", "official_status", "easement_ret", "name", "facility_id", 
    "zip_left", "description", "speed_limit", "legislation_2", "user_id", "install_date", 
    "legacy_id", "pm_oci", "prefix_dir", "state_route_no", "description_2", "alt_name", 
    "created_date", "seq_id", "us_route_no", "right_to", "geometry")

roads <- roads %>% 
  select(transport_edge_id, seq_id, full_name, prefix_dir, name, suffix_type, 
         suffix_dir, from_maint, to_maint, speed_limit, driving_time, class, 
         min_width, st_length)

interstates <- roads %>% filter(class %in% c(1,2))
highways <- roads %>% filter(class %in% c(3,4))
main_roads <- roads %>% filter(class %in% c(5))
small_roads <- roads %>% filter(class %in% c(6,7))
```

```{r}
accidents <- st_read("../data/traffic_accidents_2021_11_23/geo_export_843312ea-42b0-4c02-a5a6-277108a3e379.shp", as_tibble = T, quiet = T) %>%
  st_transform('+proj=longlat +datum=WGS84') %>%
  filter(!st_is_empty(.)) %>%
  filter(!geometry %in% st_sfc(st_point(c(0, 0))))

colnames(accidents) <-
  c("accident_n", "date", "time", "motor_vehicles_n", "injuries_n", "fatalities_n",
    "property_damage", "hit_and_run", "reporting_officer", "collision_type_code",
    "collision_type_desc", "weather_code", "weather_desc", "illumination_code",
    "illumination_desc", "harmful_code", "harmful_desc", "street_address", "city",
    "state", "zip", "rpa", "precinct", "lat", "long", "geometry")

accidents <- accidents %>%
  mutate(year = year(date), month = month(date), day = day(date), .after = date)

# 'Collision Type Code': 'Collision Type Description'
# 0: NOT COLLISION W/MOTOR VEHICLE-TRANSPORT
# 1: REAR END
# 2: HEAD-ON
# 3: REAR-TO-REAR
# 4: ANGLE
# 5: SIDESWIPE - SAME DIRECTION
# 6: SIDESWIPE - OPPOSITE DIRECTION
# 7: NaN
# 9: UNKNOWN
# 11: Front to Rear
# 16 Rear to Side
# 98: OTHER
# 99: NaN

# 'Harmful Code': 'Harmful Description'
# 01: OVERTURN
# 02: FIRE/EXPLOSION
# 04: JACKKNIFE
# 05: FELL/JUMPED FROM VEHICLE
# 07: OTHER NON-COLLISION
# 08: PEDESTRIAN
# 09: PEDALCYCLE
# 1: NaN
# 10: RAILWAY TRAIN
# 11: OTHER ANIMAL
# 12: MOTOR VEHICLE IN TRANSPORT
# 13: MOTOR VEHICLE IN TRANSPORT-OTHER ROADWAY
# 14: PARKED MOTOR VEHICLE
# 15: OTHER TYPE NON-MOTORIST
# 16: THROWN OR FALLING OBJECT
# 17: BOULDER
# 18: OTHER OBJECT (NOT FIXED)
# 19: Building
# 2: NaN
# 20: IMPACT ATTENUATOR
# 21: BRIDGE PIER/ABUTMENT
# 22: BRIDGE PARPET END
# 23: BRIDGE RAIL
# 24: GUARDRAIL FACE
# 25: GUARDRAIL END
# 26: MEDIAN BARRIER
# 27: H-WAY TRAFFIC SIGNAL POST
# 28: OVERHEAD SIGN SUPPORT
# 29: LUMINAIRE/LIGHT SUPPORT
# 3: NaN
# 30: UTILITY POLE
# 31: OTHER POST, POLE, SUPP.
# 32: CULVERT
# 33: CURB
# 34: DITCH
# 35: EMBANKMENT
# 36: CONCRETE TRAFFIC BARRIER 
# 37: Other Traffic Barrier
# 38: FENCE
# 39: WALL
# 4: NaN
# 40: MAIL BOX
# 41: SHRUBBERY
# 42: TREE
# 43: OTHER FIXED OBJECTS
# 44: PAVED SURFACE-IRREGULAR
# 45: WORKING MOTOR VEHICLE
# 46: TRAFFIC SIGNAL SUPPORT
# 47: FIRE HYDRANT
# 48: SNOW BANK
# 49: Ridden Animal/Drawn Conveyance
# 5: NaN
# 50: DEER (ANIMAL)
# 54: Set In Motion By Motor Vehicle
# 55: Vehicle-In-Motion Outside Traffic
# 57: Cable Barrier
# 6: NaN
# 60: Cargo Equip Loss/Shift
# 63: Ran Off Road-Right
# 64: Ran Off Road-Left
# 7: NaN
# 71: EMBANKMENT EARTH
# 72: EMBANKMENT ROCK/STONE/CONCRETE
# 73: EMBANKMENT MATERIAL UNKNOWN
# 74: Occupant Struck By Own Vehicle
# 75: Bridge/Overhead Structure
# 8: PEDESTRIAN
# 9: NaN
# 99: UNKNOWN MOST HARMFUL EVENT
```

```{r}
accidents_filtered <- accidents %>% 
  sample_n(500)

accidents_filtered$label <- 
  paste0("<b>Date:</b> ", accidents_filtered$date, "<br>",
         "<b>Time:</b> ", accidents_filtered$time, "<br>", 
         "<b>Street Address:</b> ", accidents_filtered$street_address, "<br>",
         "<b>Harmful Description:</b> ", accidents_filtered$harmful_desc) %>%
  lapply(htmltools::HTML)

map <- leaflet(options = leafletOptions(minZoom = 10, dragging = TRUE)) %>%
  addProviderTiles(provider = "CartoDB.PositronNoLabels") %>%
  setView(lng = -86.7816, lat = 36.1627, zoom = 11) %>%
  setMaxBounds(lng1 = -86.7816 + 1, 
               lat1 = 36.1627 + 1, 
               lng2 = -86.7816 - 1, 
               lat2 = 36.1627 - 1) %>%
  addPolylines(data = small_roads, color = "lightgrey", opacity = 0.75, weight = 0.5) %>%
  addPolylines(data = highways, color = "grey", opacity = 0.5, weight = 1) %>%
  addPolylines(data = main_roads, color = "lightgrey", opacity = 1, weight = 0.5) %>%
  addPolylines(data = interstates, color = "#F6CF65", opacity = 0.8, weight = 2) %>%
  addCircleMarkers(data = accidents_filtered,
                   weight = 0.5,
                   radius = 2,
                   fillColor = "red",
                   fillOpacity = 0.75,
                   color = "white",
                   label = ~label)

map
```

```{r}
nearest <- st_nearest_feature(accidents, roads)
accidents_roads <- bind_cols(accidents %>% st_drop_geometry(), roads[nearest, ])
```

```{r}
accidents_roads %>% 
  count(year, sort = F)

accidents_roads %>% 
  count(motor_vehicles_n, sort = T)

accidents_roads %>% 
  count(injuries_n, sort = T)

accidents_roads %>% 
  count(property_damage, sort = T)

accidents_roads %>% 
  count(hit_and_run, sort = T)

accidents_roads %>% 
  count(collision_type_desc, sort = T)

accidents_roads %>% 
  count(weather_desc, sort = T)

accidents_roads %>% 
  count(illumination_desc, sort = T)
```




```{r}
pedestrians <- accidents_roads[grepl("PEDESTRIAN", accidents_roads$harmful_desc), ]

pedestrians %>% 
  count(motor_vehicles_n, sort = T)

pedestrians %>% 
  count(injuries_n, sort = T)

pedestrians %>% 
  count(property_damage, sort = T)

pedestrians %>% 
  count(hit_and_run, sort = T)

pedestrians %>% 
  count(collision_type_desc, sort = T)

pedestrians %>% 
  count(weather_desc, sort = T)

pedestrians %>% 
  count(illumination_desc, sort = T)
```

```{r}
bicyclists <- accidents_roads[grepl("PEDALCYCLE", accidents_roads$harmful_desc), ]

bicyclists %>% 
  count(motor_vehicles_n, sort = T)

bicyclists %>% 
  count(injuries_n, sort = T)

bicyclists %>% 
  count(property_damage, sort = T)

bicyclists %>% 
  count(hit_and_run, sort = T)

bicyclists %>% 
  count(collision_type_desc, sort = T)

bicyclists %>% 
  count(weather_desc, sort = T)

bicyclists %>% 
  count(illumination_desc, sort = T)
```

